{% extends "base.html" %}
{% block content %}
<div class="row">
  <div class="col-md-8 offset-md-2">
    <h3>Stock analysis</h3>

    <form id="analyze-form" class="mb-3">
      <div class="input-group">
        <input type="text" id="ticker" name="ticker" class="form-control" placeholder="Ticker (e.g., AAPL)" required>
        <button id="analyze-btn" class="btn btn-primary" type="submit">Analyze</button>
      </div>
    </form>

    <div class="mb-4">
      <h5>Popular Stocks</h5>
      <table class="table table-striped table-sm">
        <thead>
          <tr>
            <th>Ticker</th>
            <th>Company</th>
            <th>Price</th>
            <th>Change (%)</th>
            <th>P/E</th>
            <th>Beta</th>
          </tr>
        </thead>
        <tbody>
          {% for s in default_stocks %}
          <tr>
            <td><strong>{{ s.ticker }}</strong></td>
            <td>{{ s.company or "-" }}</td>
            <td>${{ s.price or "N/A" }}</td>
            <td
              style="color: {% if s.change_pct and s.change_pct > 0 %}green{% elif s.change_pct and s.change_pct < 0 %}red{% else %}black{% endif %}">
              {{ s.change_pct or "N/A" }}%
            </td>
            <td>{{ s.pe_ratio or "N/A" }}</td>
            <td>{{ s.beta or "N/A" }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div id="analysis-area" style="display:none;">
      <h5 id="analysis-title"></h5>
      <div id="analysis-insight" class="mb-3"></div>

      <h6>Price & summary</h6>
      <div id="analysis-stock" class="mb-3"></div>

      <h6>Recent history (last 30 rows)</h6>
      <div id="history-preview" style="max-height:300px; overflow:auto; font-size:0.9em;"></div>
    </div>
  </div>
</div>

<script>
  document.getElementById("analyze-form").addEventListener("submit", async function (e) {
    e.preventDefault();
    const ticker = document.getElementById("ticker").value.trim().toUpperCase();
    if (!ticker) return;
    const payload = { ticker };

    // --- UX Improvement: Loading State ---
    const button = document.getElementById("analyze-btn");
    button.disabled = true;
    button.innerText = "Analyzing...";

    try {
      const resp = await fetch("/api/analyze", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      // Ensure we handle non-JSON or error responses gracefully
      if (!resp.ok) {
        const errorData = await resp.json().catch(() => ({ message: "Server error occurred" }));
        alert("Error: " + (errorData.message || errorData.status || "Unknown error"));
        return;
      }

      const json = await resp.json();

      if (json.status === "error") {
        alert("Error: " + json.message);
        return;
      }

      // Success path
      document.getElementById("analysis-area").style.display = "block";

      const stockName = json.stock.name || "Unknown Company";
      const stockTicker = json.stock.ticker || ticker;
      document.getElementById("analysis-title").innerText = `${stockName} (${stockTicker})`;

      // UX Improvement: Redirect to summary page after a short delay or immediately
      window.location.href = "/insight_summary";

      // (Optional) Update the current page's UI in case redirect is slow or disabled
      const price = json.stock.price || "N/A";
      const change = json.stock.pct_change || "N/A";
      const pe = json.stock.pe_ratio || "N/A";
      let changeColor = 'black';

      if (change !== "N/A" && !isNaN(parseFloat(change))) {
        changeColor = (parseFloat(change) > 0) ? 'green' : (parseFloat(change) < 0) ? 'red' : 'black';
      }

      document.getElementById("analysis-stock").innerHTML =
        `Price: $${price}   
         Change: <span style="font-weight: bold; color:${changeColor}">${change}%</span>   
         P/E: ${pe}`;

      // History Preview (if available in the response)
      const hp = json.history_preview || [];
      let html = "<table class='table table-sm'><thead><tr>";
      if (hp.length > 0) {
        Object.keys(hp[0]).forEach(k => { html += "<th>" + k + "</th>" });
        html += "</tr></thead><tbody>";
        hp.forEach(r => {
          html += "<tr>";
          Object.keys(r).forEach(k => html += "<td>" + (r[k] === null ? "" : String(r[k]).slice(0, 20)) + "</td>");
          html += "</tr>";
        });
        html += "</tbody></table>";
      } else {
        html = "<p>Analyzing recent history...</p>";
      }
      document.getElementById("history-preview").innerHTML = html;

    } catch (error) {
      console.error("Analysis failed:", error);
      alert("Network Error: " + error.message + "\nCheck console for details.");
    } finally {
      button.disabled = false;
      button.innerText = "Analyze";
    }
  });
</script>
{% endblock %}