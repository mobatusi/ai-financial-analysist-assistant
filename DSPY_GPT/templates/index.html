{% extends "base.html" %}
{% block content %}
<div class="row">
  <div class="col-md-8 offset-md-2">
    <h3>Stock analysis</h3>

    <form id="analyze-form" class="mb-3">
      <div class="input-group">
        <input type="text" id="ticker" name="ticker" class="form-control" placeholder="Ticker (e.g., AAPL)" required>
        <button id="analyze-btn" class="btn btn-primary" type="submit">Analyze</button>
      </div>
    </form>

    <div class="mb-4">
      <h5>Popular Stocks</h5>
      <table class="table table-striped table-sm">
        <thead>
          <tr>
            <th>Ticker</th>
            <th>Company</th>
            <th>Price</th>
            <th>Change (%)</th>
            <th>P/E</th>
            <th>Beta</th>
          </tr>
        </thead>
        <tbody>
          {% for s in default_stocks %}
          <tr>
            <td><strong>{{ s.ticker }}</strong></td>
            <td>{{ s.company or "-" }}</td>
            <td>${{ s.price or "N/A" }}</td>
            <td
              style="color: {% if s.change_pct and s.change_pct > 0 %}green{% elif s.change_pct and s.change_pct < 0 %}red{% else %}black{% endif %}">
              {{ s.change_pct or "N/A" }}%
            </td>
            <td>{{ s.pe_ratio or "N/A" }}</td>
            <td>{{ s.beta or "N/A" }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div id="analysis-area" style="display:none;">
      <h5 id="analysis-title"></h5>
      <div id="analysis-insight" class="mb-3"></div>

      <h6>Price & summary</h6>
      <div id="analysis-stock" class="mb-3"></div>

      <h6>Recent history (last 30 rows)</h6>
      <div id="history-preview" style="max-height:300px; overflow:auto; font-size:0.9em;"></div>
    </div>
  </div>
</div>

<script>
  document.getElementById("analyze-form").addEventListener("submit", async function (e) {
    e.preventDefault();
    const ticker = document.getElementById("ticker").value.trim().toUpperCase();
    if (!ticker) return;
    const payload = { ticker };

    // --- UX Improvement: Loading State ---
    const button = document.getElementById("analyze-btn");
    button.disabled = true;
    button.innerText = "Analyzing...";

    try {
      const resp = await fetch("/api/analyze", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      // Check if response is OK before parsing JSON
      if (!resp.ok) {
        const errorText = await resp.text();
        let errorMessage = "Server error";
        try {
          const errorJson = JSON.parse(errorText);
          errorMessage = errorJson.error || errorJson.details || errorMessage;
        } catch {
          errorMessage = errorText || `HTTP ${resp.status}: ${resp.statusText}`;
        }
        alert("Analysis failed: " + errorMessage);
        return;
      }

      const json = await resp.json();

      if (json.error) {
        alert("Error: " + json.error);
        return;
      }

      // Redirect to insight summary page on success
      window.location.href = "/insight_summary";

    } catch (error) {
      console.error("Analysis error:", error);
      const errorMsg = error.message || "Network error or server unavailable";
      alert("Analysis failed: " + errorMsg);
    } finally {
      // --- UX Improvement: Reset Button State ---
      button.disabled = false;
      button.innerText = "Analyze";
    }
  });
</script>
{% endblock %}